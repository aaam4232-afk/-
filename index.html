<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ ğŸ›’</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <meta name="theme-color" content="#004d40">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù†">
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081986.png">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22%D8%B3%D9%88%D9%82%20%D8%B9%D8%B2%D8%A7%D9%86%20%D8%A7%D9%84%20%D9%85%D9%88%D8%AD%D8%AF%22,%22short_name%22:%22%D8%B3%D9%88%D9%82%20%D8%B9%D8%B2%D8%A7%D9%86%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f4f7f6%22,%22theme_color%22:%22%23004d40%22}">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --primary: #004d40; --orange: #ff6d00; --bg: #f4f7f6; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        /* ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø®ØµØµ ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© */
        .msg-toast {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            padding: 12px 25px; border-radius: 12px; color: white; font-weight: 800;
            z-index: 9999; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-size: 0.9rem; text-align: center; min-width: 200px;
        }

        .header { background: linear-gradient(135deg, var(--primary), #00796b); color: white; padding: 30px 20px 50px; text-align: center; border-radius: 0 0 30px 30px; }
        .header h1 { margin: 0; font-size: 1.6rem; font-weight: 900; }
        .main-content { padding: 0 15px; margin-top: -25px; }
        .section-card { background: white; border-radius: 20px; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .title-label { font-weight: 800; font-size: 0.9rem; margin-bottom: 12px; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .grid-small { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .offer-box { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 12px; text-align: center; cursor: pointer; }
        .offer-box b { display: block; font-size: 0.8rem; margin: 5px 0; }
        .status-tag { font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 5px; }
        .has { color: #2e7d32; background: #e8f5e9; }
        .none { color: #9e9e9e; background: #f5f5f5; }
        .directory-list { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none; }
        .dir-pill { background: var(--primary); color: white; padding: 10px 18px; border-radius: 25px; font-size: 0.8rem; font-weight: 700; white-space: nowrap; cursor: pointer; border: none; }
        .full-page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 4000; overflow-y: auto; }
        .top-nav { background: white; padding: 15px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .back-btn { background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .merchant-area { padding: 20px; }
        .m-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #ddd; font-family: 'Tajawal'; box-sizing: border-box; outline: none; }
        .m-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 800; cursor: pointer; }
        .product-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 15px; border-right: 4px solid #ddd; }
        .is-offer { border-right-color: var(--orange); background: #fff9f0; }
        .info-row { display: block; font-size: 0.8rem; color: #555; margin-top: 4px; border-top: 1px dashed #ddd; padding-top: 4px; }
        .call-btn { background: #2ecc71; color: white; padding: 6px 15px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 800; display: inline-block; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="customMsg" class="msg-toast"></div>
    <audio id="waterSnd"><source src="https://www.soundjay.com/nature/sounds/water-droplet-1.mp3"></audio>

    <div class="header">
        <h1>Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ ğŸ›’</h1>
        <p>Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„ØªØ³ÙˆÙ‚ ÙÙŠ Ø¹Ø²Ø§Ù†</p>
    </div>

    <div class="main-content">
        <div class="section-card">
            <div class="title-label">ğŸ”¥ Ø¹Ø±ÙˆØ¶ ÙˆØªØ®ÙÙŠØ¶Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="grid-small">
                <div class="offer-box" onclick="openGlobalOffers('Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§', 'ğŸ”')"><span>ğŸ”</span><b>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</b><span id="st-Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§" class="status-tag none">ÙØ­Øµ...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', 'ğŸ')"><span>ğŸ</span><b>Ø§Ù„ØºØ°Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©" class="status-tag none">ÙØ­Øµ...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'ğŸ—ï¸')"><span>ğŸ—ï¸</span><b>Ø§Ù„Ø¨Ù†Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©" class="status-tag none">ÙØ­Øµ...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'âš¡')"><span>âš¡</span><b>Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡" class="status-tag none">ÙØ­Øµ...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰', 'ğŸ›’')" style="grid-column: span 2;"><span>ğŸ›’</span><b>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰</b><span id="st-Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰" class="status-tag none">ÙØ­Øµ...</span></div>
            </div>
        </div>

        <div class="section-card" style="background:transparent; box-shadow:none; padding:0;">
            <div class="title-label">ğŸ“‚ Ø¯Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ù„Ø§Øª Ø¹Ø²Ø§Ù†</div>
            <div class="directory-list">
                <div class="dir-pill" onclick="openFullDirectory('Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§')">ğŸ˜ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</div>
                <div class="dir-pill" onclick="openFullDirectory('Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©')">ğŸ± Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª</div>
                <div class="dir-pill" onclick="openFullDirectory('Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©')">ğŸ› ï¸ Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡</div>
                <div class="dir-pill" onclick="openFullDirectory('Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡')">ğŸ’¡ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ§Øª</div>
                <div class="dir-pill" onclick="openFullDirectory('Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰')">ğŸ·ï¸ Ù…Ø­Ù„Ø§Øª Ø£Ø®Ø±Ù‰</div>
            </div>
        </div>

        <div style="padding: 10px 0;">
            <button onclick="openPage('merchantPage')" style="width:100%; padding:16px; border-radius:15px; border:none; background:#2c3e50; color:white; font-family:'Tajawal'; font-weight:800; cursor:pointer;">ğŸ” Ù„ÙˆØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ¬Ø§Ø± (Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬)</button>
        </div>
    </div>

    <div id="merchantPage" class="full-page">
        <div class="top-nav"><button class="back-btn" onclick="closePage('merchantPage')">âœ</button><h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„ØªØ§Ø¬Ø±</h3></div>
        <div id="mAuthArea" class="merchant-area">
            <input type="password" id="mCode" class="m-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠ">
            <button class="m-btn" onclick="loginMerchant()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø­Ù„</button>
        </div>
        <div id="mControlArea" class="merchant-area" style="display:none;">
            <div style="background:var(--primary); color:white; padding:15px; border-radius:15px; margin-bottom:20px;">Ù…Ø±Ø­Ø¨Ø§Ù‹: <b id="storeNameDisp"></b> âœ¨</div>
            <input type="text" id="pName" class="m-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="text" id="pPrice" class="m-input" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø±ÙŠØ§Ù„">
            <select id="pType" class="m-input">
                <option value="offer">ğŸ”¥ Ø¹Ø±Ø¶ Ø®Ø§Øµ ÙˆØªØ®ÙÙŠØ¶</option>
                <option value="normal">ğŸ“¦ Ù…Ù†ØªØ¬ Ø¹Ø§Ø¯ÙŠ</option>
            </select>
            <input type="text" id="pDur" class="m-input" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶">
            <button class="m-btn" onclick="addProduct()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù† âœ…</button>
            <div id="mMyProds"></div>
            <button onclick="logoutMerchant()" style="background:none; border:none; color:red; width:100%; margin-top:30px; cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸšª</button>
        </div>
    </div>

    <div id="offersPage" class="full-page"><div class="top-nav"><button class="back-btn" onclick="closePage('offersPage')">âœ</button><h3 id="pgTitle"></h3></div><div id="offersList"></div></div>
    <div id="directoryPage" class="full-page"><div class="top-nav"><button class="back-btn" onclick="closePage('directoryPage')">âœ</button><h3 id="dirTitle"></h3></div><div id="dirStoresList"></div></div>
    <div id="storeViewPage" class="full-page"><div class="top-nav"><button class="back-btn" onclick="closePage('storeViewPage')">âœ</button><h3 id="svTitle"></h3></div><div id="svProducts"></div></div>

    <script>
        const firebaseConfig = { databaseURL: "https://souq-tarim-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„ØµÙØ­Ø©
        function callMsg(txt, type) {
            const box = document.getElementById('customMsg');
            box.innerText = txt;
            box.style.background = type === 'success' ? '#27ae60' : (type === 'error' ? '#c0392b' : '#f39c12');
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 2000);
        }

        function playWater() { document.getElementById('waterSnd').play().catch(()=>{}); }
        function openPage(id) { playWater(); document.getElementById(id).style.display='block'; if(id==='merchantPage') checkAuth(); }
        function closePage(id) { playWater(); document.getElementById(id).style.display='none'; }

        function loginMerchant() {
            const code = document.getElementById('mCode').value.trim();
            if (!code) {
                callMsg("âš ï¸ Ø£ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø² Ø£ÙˆÙ„Ø§Ù‹!", "warn");
                return;
            }
            db.ref('Stores/' + code).once('value', (s) => {
                if(s.exists()){
                    localStorage.setItem('azKey', code);
                    localStorage.setItem('azName', s.val().name);
                    showMerchantUI();
                    callMsg("âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­", "success");
                } else { 
                    callMsg("âŒ Ø§Ù„Ø±Ù…Ø² ØºÙ„Ø·!", "error");
                }
            });
        }

        function checkAuth() { if(localStorage.getItem('azKey')) showMerchantUI(); }
        function showMerchantUI() {
            document.getElementById('mAuthArea').style.display = 'none';
            document.getElementById('mControlArea').style.display = 'block';
            document.getElementById('storeNameDisp').innerText = localStorage.getItem('azName');
            loadMyProducts();
        }

        function addProduct() {
            const key = localStorage.getItem('azKey');
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            const type = document.getElementById('pType').value;
            const dur = document.getElementById('pDur').value;
            if(!name || !price) {
                callMsg("âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!", "warn");
                return;
            }
            db.ref('Products/' + key).push({ name, price, type, duration: dur }).then(() => {
                callMsg("ğŸš€ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø³Ù„Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­", "success");
                document.getElementById('pName').value=""; document.getElementById('pPrice').value=""; document.getElementById('pDur').value="";
            });
        }

        function loadMyProducts() {
            const key = localStorage.getItem('azKey');
            db.ref('Products/' + key).on('value', (snap) => {
                const list = document.getElementById('mMyProds'); list.innerHTML = "";
                snap.forEach(p => {
                    list.innerHTML += <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${p.val().name}</span><button onclick="deleteProd('${p.key}')" style="color:red; border:none; background:none;">Ø­Ø°Ù</button></div>;
                });
            });
        }

        function deleteProd(pid) {
            db.ref('Products/' + localStorage.getItem('azKey') + '/' + pid).remove();
            callMsg("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù", "warn");
        }

        function logoutMerchant() { localStorage.clear(); location.reload(); }

        function openGlobalOffers(cat, icon) {
            playWater(); document.getElementById('pgTitle').innerText = icon + " Ø¹Ø±ÙˆØ¶ " + cat;
            const list = document.getElementById('offersList'); list.innerHTML = "";
            openPage('offersPage');
            db.ref('Stores').orderByChild('category').equalTo(cat).once('value', (sSnap) => {
                const stores = sSnap.val() || {};
                db.ref('Products').on('value', (pSnap) => {
                    list.innerHTML = "";
                    const allP = pSnap.val() || {};
                    Object.keys(stores).forEach(sid => {
                        if(allP[sid]) {
                            Object.values(allP[sid]).forEach(p => {
                                if(p.type==='offer') {
                                    list.innerHTML += `<div class="product-card is-offer">
                                        <b>${p.name}</b> <span style="float:left; color:var(--orange); font-weight:900;">${p.price} Ø±ÙŠØ§Ù„</span><br>
                                        <span class="info-row">â³ Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶: ${p.duration || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                        <span class="info-row">ğŸª Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„: ${stores[sid].name}</span>
                                        <a href="tel:${stores[sid].phone}" class="call-btn">ğŸ“ Ø§ØªØµØ§Ù„ ÙˆØ·Ù„Ø¨</a>
                                    </div>`;
                                }
                            });
                        }
                    });
                });
            });
        }

        function openFullDirectory(cat) {
            playWater(); document.getElementById('dirTitle').innerText = "Ø¯Ù„ÙŠÙ„ " + cat;
            const list = document.getElementById('dirStoresList'); list.innerHTML = "";
            openPage('directoryPage');
            db.ref('Stores').orderByChild('category').equalTo(cat).once('value', (snap) => {
                snap.forEach(s => {
                    list.innerHTML += <div class="product-card" onclick="viewStore('${s.key}', '${s.val().name}', '${s.val().phone}')"><b>${s.val().name}</b><span style="float:left;">âœ</span></div>;
                });
            });
        }

        function viewStore(id, name, phone) {
            playWater(); document.getElementById('svTitle').innerText = name;
            const list = document.getElementById('svProducts'); list.innerHTML = "";
            openPage('storeViewPage');
            db.ref('Products/' + id).once('value', (snap) => {
                snap.forEach(p => {
                    const isO = p.val().type === 'offer';
                    list.innerHTML += `<div class="product-card ${isO ? 'is-offer' : ''}">
                        <b>${isO?'ğŸ”¥ ':''}${p.val().name}</b> <span style="float:left;">${p.val().price} Ø±ÙŠØ§Ù„</span><br>
                        ${p.val().duration ? <span class="info-row">â³ Ø§Ù„Ù…Ø¯Ø©: ${p.val().duration}</span> : ''}
                    </div>`;
                });
                list.innerHTML += <div style="text-align:center"><a href="tel:${phone}" class="call-btn" style="padding:12px 30px;">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø­Ù„</a></div>;
            });
        }

        function syncStatus() {
            const cats = ['Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', 'Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§', 'Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'Ø³Ù„Ø¹ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ø®Ø±Ù‰'];
            db.ref('Products').on('value', (pSnap) => {
                const prods = pSnap.val() || {};
                db.ref('Stores').once('value', (sSnap) => {
                    const stores = sSnap.val() || {};
                    cats.forEach(c => {
                        let hasOffer = false;
                        Object.keys(stores).forEach(id => {
                            if(stores[id].category === c && prods[id]) {
                                Object.values(prods[id]).forEach(pr => { if(pr.type==='offer') hasOffer=true; });
                            }
                        });
                        const el = document.getElementById('st-'+c);
                        if(el){
                            el.innerText = hasOffer ? "âœ… ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶";
                            el.className = "status-tag " + (hasOffer ? "has" : "none");
                        }
                    });
                });
            });
        }
        syncStatus();
    </script>
</body>
</html>